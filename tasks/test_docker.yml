---
# This task verifies Docker container states, images, and health
# status.
# verify_docker_containers should be a list of dicts with required
# 'name' and 'state' keys:
# verify_docker_containers:
#   - name: "my-container"
#     state: "running"
#     image: "nginx:latest"  # optional - validates container is
#                            # using this image
#     health: "healthy"      # optional - validates health check
#                            # status (requires health check
#                            # configured)

- name: "Verify Docker container states and configurations"
  when:
    - verify_docker_containers is defined
    - verify_docker_containers | length > 0
  environment: "{{ verify_docker_env | default({}) }}"
  block:
    - name: Validate container definitions
      ansible.builtin.assert:
        that:
          - item.name is defined
          - item.name | length > 0
          - item.state is defined
        fail_msg: "Container definition missing required fields: {{ item }}"
        quiet: true
      loop: "{{ verify_docker_containers }}"
      loop_control:
        label: "{{ item.name | default('unnamed') }}"

    - name: Inspect and validate all containers
      block:
        - name: "Inspect container {{ container.name }}"
          community.docker.docker_container_info:
            name: "{{ container.name }}"
          register: current_container_info
          failed_when: false

        - name: Check if container exists
          ansible.builtin.assert:
            that:
              - current_container_info.exists | default(false)
            fail_msg: "Container '{{ container.name }}' does not exist"
            success_msg: "Container '{{ container.name }}' found"
            quiet: true

        - name: Validate container structure
          ansible.builtin.assert:
            that:
              - current_container_info.container is defined
              - current_container_info.container.State is defined
              - current_container_info.container.Config is defined
            fail_msg: >-
              Container '{{ container.name }}' has unexpected
              structure - missing State or Config
            quiet: true

        - name: Validate container state
          ansible.builtin.assert:
            that:
              - >-
                (container.state == 'stopped' and
                current_container_info.container.State.Status
                in ['exited', 'stopped']) or
                (container.state != 'stopped' and
                current_container_info.container.State.Status
                == container.state)
            fail_msg: >-
              Container '{{ container.name }}' state mismatch:
              Expected: {{ container.state }}
              Actual: {{ current_container_info.container.State.Status }}
            quiet: true

        - name: Validate container image
          when: container.image is defined
          ansible.builtin.assert:
            that:
              - >-
                current_container_info.container.Config.Image
                == container.image
            fail_msg: >-
              Container '{{ container.name }}' image mismatch:
              Expected: {{ container.image }}
              Actual: {{ current_container_info.container.Config.Image }}
            quiet: true

        - name: Check if container has health check configured
          when: container.health is defined
          ansible.builtin.assert:
            that:
              - current_container_info.container.State.Health is defined
            fail_msg: >-
              Container '{{ container.name }}' health check
              validation failed:
              Health check is not configured for this container,
              but expected health status: {{ container.health }}
              To fix: Either configure a health check in the
              container, or remove 'health' from the test
              definition
            quiet: true

        - name: Validate container health status
          when:
            - container.health is defined
            - current_container_info.container.State.Health is defined
          ansible.builtin.assert:
            that:
              - >-
                current_container_info.container.State.Health.Status
                == container.health
            fail_msg: >-
              Container '{{ container.name }}' health status mismatch:
              Expected: {{ container.health }}
              Actual: {{ current_container_info.container.State.Health.Status }}
            quiet: true

        - name: Container validation summary
          ansible.builtin.debug:
            msg: >-
              ✓ Container '{{ container.name }}' passed all
              validations
              State: {{ current_container_info.container.State.Status }}
              {% if container.image is defined %}Image:
              {{ current_container_info.container.Config.Image }}
              {% endif %}
              {% if container.health is defined and
              current_container_info.container.State.Health
              is defined %}Health:
              {{ current_container_info.container.State.Health.Status }}
              {% endif %}
            verbosity: 1

      rescue:
        - name: Log container validation failure
          ansible.builtin.debug:
            msg: >-
              ✗ Failed to validate container '{{ container.name }}':
              {{ ansible_failed_result.msg | default('Unknown error') }}
          failed_when: true

  rescue:
    - name: Log Docker verification failure
      ansible.builtin.debug:
        msg: >-
          ✗ Docker container verification failed:
          {{ ansible_failed_result.msg |
          default('Docker daemon may be unreachable or containers
          not properly defined') }}
      failed_when: true
