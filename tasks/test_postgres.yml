---
# This task verifies PostgreSQL database existence, roles, tables,
# and data records.
#
# Required connection variables:
#   postgres_db: "mydb"           # Database name to check
#   postgres_host: "localhost"    # PostgreSQL host
#   postgres_user: "postgres"     # Database user with appropriate permissions
#   postgres_password: "secret"   # Database password
#   postgres_port: 5432           # PostgreSQL port (default: 5432)
#
# Required test definition variables:
#   postgres_expected_roles:      # List of role names that must exist
#     - "app_user"
#     - "readonly_user"
#
#   postgres_expected_tables:     # List of table names that must
#                                 # exist (can be
#                                 # schema-qualified)
#     - "users"
#     - "public.orders"
#
#   postgres_expected_records:    # List of queries that must
#                                 # return at least one row
#     - query: "SELECT * FROM users WHERE role = 'admin'"
#       description: "Admin user exists"  # optional, for clearer
#                                         # error messages
#     - query: "SELECT * FROM orders WHERE status = 'pending'"
#       description: "Pending orders exist"

- name: "Verify PostgreSQL database configuration and data"
  block:
    - name: Check Postgres DB exists
      community.postgresql.postgresql_db:
        name: "{{ postgres_db }}"
        state: present
        login_host: "{{ postgres_host }}"
        login_user: "{{ postgres_user }}"
        login_password: "{{ postgres_password }}"
        port: "{{ postgres_port | default(5432) }}"
      check_mode: true
      register: db_check
      failed_when: false

    - name: Validate database exists
      ansible.builtin.assert:
        that:
          - db_check is succeeded
        fail_msg: >-
          Database '{{ postgres_db }}' does not exist or is not
          accessible
        success_msg: "Database '{{ postgres_db }}' exists"

    - name: Check Postgres roles exist
      community.postgresql.postgresql_info:
        filter: roles
        login_host: "{{ postgres_host }}"
        login_user: "{{ postgres_user }}"
        login_password: "{{ postgres_password }}"
        port: "{{ postgres_port | default(5432) }}"
      register: pg_roles
      when: >-
        postgres_expected_roles is defined and
        postgres_expected_roles | length > 0

    - name: Assert required roles exist
      ansible.builtin.assert:
        that:
          - item in (pg_roles.roles.keys() | list)
        fail_msg: "PostgreSQL role '{{ item }}' is missing"
        success_msg: "PostgreSQL role '{{ item }}' exists"
        quiet: true
      loop: "{{ postgres_expected_roles }}"
      loop_control:
        label: "Role: {{ item }}"
      when: >-
        postgres_expected_roles is defined and
        postgres_expected_roles | length > 0

    - name: Check required tables exist
      when: >-
        postgres_expected_tables is defined and
        postgres_expected_tables | length > 0
      block:
        - name: Query for existing tables
          community.postgresql.postgresql_query:
            db: "{{ postgres_db }}"
            query: |
              SELECT schemaname || '.' || tablename as full_name
              FROM pg_tables
              WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
            login_host: "{{ postgres_host }}"
            login_user: "{{ postgres_user }}"
            login_password: "{{ postgres_password }}"
            port: "{{ postgres_port | default(5432) }}"
          register: pg_tables_query

        - name: Extract table names from query result
          ansible.builtin.set_fact:
            available_tables: >-
              {{ pg_tables_query.query_result |
              map(attribute='full_name') | list }}

        - name: Assert required tables exist
          ansible.builtin.assert:
            that:
              - >-
                item in available_tables or
                ('public.' + item) in available_tables
            fail_msg: >-
              Table '{{ item }}' is missing from database
              '{{ postgres_db }}'.
              Available tables: {{ available_tables | join(', ') }}
            success_msg: "Table '{{ item }}' exists"
            quiet: true
          loop: "{{ postgres_expected_tables }}"
          loop_control:
            label: "Table: {{ item }}"

    - name: Verify data records exist
      when: >-
        postgres_expected_records is defined and
        postgres_expected_records | length > 0
      block:
        - name: >-
            Execute query:
            {{ record.description |
            default(record.query | truncate(60)) }}
          community.postgresql.postgresql_query:
            db: "{{ postgres_db }}"
            query: "{{ record.query }}"
            login_host: "{{ postgres_host }}"
            login_user: "{{ postgres_user }}"
            login_password: "{{ postgres_password }}"
            port: "{{ postgres_port | default(5432) }}"
          register: query_result
          loop: "{{ postgres_expected_records }}"
          loop_control:
            loop_var: record
            label: >-
              {{ record.description |
              default(record.query | truncate(50)) }}

        - name: "Validate query returned rows"
          ansible.builtin.assert:
            that:
              - item.rowcount is defined
              - item.rowcount > 0
            fail_msg: |
              [FAIL] Query validation failed
              {% if postgres_expected_records[idx].description
              is defined %}Description:
              {{ postgres_expected_records[idx].description }}
              {% endif %}
              Query: {{ postgres_expected_records[idx].query }}
              Expected: At least 1 row
              Actual: {{ item.rowcount | default(0) }} rows
            success_msg: |
              [PASS] Query returned {{ item.rowcount }} row(s)
              {% if postgres_expected_records[idx].description
              is defined %}Description:
              {{ postgres_expected_records[idx].description }}
              {% endif %}
            quiet: true
          loop: "{{ query_result.results }}"
          loop_control:
            index_var: idx
            label: "Query {{ idx + 1 }}"

  rescue:
    - name: Log PostgreSQL verification failure
      ansible.builtin.debug:
        msg: |
          [ERROR] PostgreSQL verification failed
          Database: {{ postgres_db | default('undefined') }}
          Host: {{ postgres_host | default('undefined') }}
          Error: {{ ansible_failed_result.msg |
          default('Connection or permission issue') }}
      failed_when: true
